import J from"https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/+esm";import ye from"https://cdn.jsdelivr.net/npm/file-saver@2.0.5/+esm";import ue from"https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Q=ye.saveAs,z=document.getElementById("fileInput"),U=document.getElementById("directoryInput"),L=document.getElementById("selectFile"),F=document.getElementById("selectDirectory"),E=document.getElementById("dropArea"),B=document.getElementById("fileListContainer"),I=document.getElementById("fileList"),R=document.getElementById("fileCount"),q=document.getElementById("fileInfo"),V=document.getElementById("originalHash"),u=document.getElementById("modifyBtn"),d=document.getElementById("modifyAllBtn"),X=document.getElementById("modifiedHash"),m=document.getElementById("downloadBtn"),p=document.getElementById("downloadAllBtn"),a=document.getElementById("status"),Y=document.getElementById("progressContainer"),ee=document.getElementById("progressBar"),te=document.getElementById("progressText"),G=document.getElementById("batchResults"),D=document.getElementById("resultsList"),b=document.getElementById("previewContainer"),C=document.getElementById("batchPreviewContainer"),h=document.getElementById("previewContent"),f=document.getElementById("allTypes"),x=document.querySelectorAll('input[name="fileType"]'),Z=document.getElementById("customExtension"),me=document.getElementById("addCustomType"),_=document.getElementById("customTypesList"),T=document.getElementById("appendData"),ne=document.getElementById("appendText"),N=document.getElementById("changeBytes"),se=document.getElementById("bytePosition"),ie=document.getElementById("byteValue");let c=null,k=null,P=[],y=[],oe=null,w=[],r=[];const j={image:["jpg","jpeg","png","gif","bmp","webp","svg","tiff","ico"],text:["txt","md","csv","json","xml","log","ini","cfg","conf"],document:["doc","docx","pdf","odt","rtf","tex","ppt","pptx","xls","xlsx"],audio:["mp3","wav","ogg","flac","aac","m4a","wma"],video:["mp4","avi","mov","wmv","flv","mkv","webm"],archive:["zip","rar","7z","tar","gz","bz2","xz"],code:["js","ts","html","css","scss","less","php","py","java","c","cpp","cs","go","rb","pl","sh","bat"]};L.addEventListener("change",()=>{L.checked&&(B.style.display="none",u.style.display="block",d.style.display="none",m.style.display="block",p.style.display="none",G.style.display="none",b.style.display="none",C.style.display="none",H())});F.addEventListener("change",()=>{F.checked&&(B.style.display="block",u.style.display="none",d.style.display="block",m.style.display="none",p.style.display="block",b.style.display="none",C.style.display="block",H())});E.addEventListener("click",()=>{L.checked?z.click():U.click()});["dragenter","dragover","dragleave","drop"].forEach(e=>{E.addEventListener(e,fe,!1)});function fe(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover"].forEach(e=>{E.addEventListener(e,()=>{E.classList.add("active")},!1)});["dragleave","drop"].forEach(e=>{E.addEventListener(e,()=>{E.classList.remove("active")},!1)});E.addEventListener("drop",ge,!1);async function ge(e){const t=e.dataTransfer.items;if(t.length!==0)if(t[0].webkitGetAsEntry&&t[0].webkitGetAsEntry().isDirectory){F.checked=!0,B.style.display="block",u.style.display="none",d.style.display="block",m.style.display="none",p.style.display="block",b.style.display="none",C.style.display="block";const n=Array.from(t).map(s=>s.webkitGetAsEntry()),i=await le(n);i.length>0&&O(i)}else{const n=Array.from(e.dataTransfer.files);n.length===1?(L.checked=!0,B.style.display="none",u.style.display="block",d.style.display="none",m.style.display="block",p.style.display="none",G.style.display="none",C.style.display="none",ce(n[0])):n.length>1&&(F.checked=!0,B.style.display="block",u.style.display="none",d.style.display="block",m.style.display="none",p.style.display="block",b.style.display="none",C.style.display="block",O(n))}}async function le(e){const t=[];for(const n of e)if(n.isFile){const i=await he(n);t.push(i)}else if(n.isDirectory){const i=await Ee(n);t.push(...i)}return t}function he(e){return new Promise(t=>{e.file(n=>{t(n)})})}function Ee(e){return new Promise(t=>{const n=e.createReader(),i=[];function s(){n.readEntries(async o=>{if(o.length===0)t(i);else{const l=await le(o);i.push(...l),s()}})}s()})}function $(e){const t=J.lib.WordArray.create(e);return J.MD5(t).toString()}function be(e){return new TextEncoder().encode(e).buffer}function ve(e){return parseInt(e,16)}function ae(e){return e.split(".").pop().toLowerCase()}function xe(e){if(f.checked)return!0;const t=ae(e.name);if(w.includes(t))return!0;for(const n of x)if(n.checked){const i=n.value;if(j[i]&&j[i].includes(t))return!0}return!1}function A(){r=P.filter(e=>xe(e)),re(),R.textContent=`${r.length} (从 ${P.length} 个文件中筛选)`,d.disabled=r.length===0}function re(){I.innerHTML="",r.forEach((e,t)=>{const n=document.createElement("div");n.className="file-item";const i=ae(e.name);let s="未知";for(const[o,l]of Object.entries(j))if(l.includes(i)){s={image:"图片",text:"文本",document:"文档",audio:"音频",video:"视频",archive:"压缩包",code:"代码"}[o]||o;break}n.innerHTML=`
      ${e.name} <span class="file-type-badge">${s}</span>
    `,n.dataset.index=t,n.addEventListener("click",()=>S(t)),I.appendChild(n)})}function ce(e){if(!e){H();return}c=e,q.innerHTML=`
    <p><strong>名称:</strong> ${e.name}</p>
    <p><strong>大小:</strong> ${(e.size/1024).toFixed(2)} KB</p>
    <p><strong>类型:</strong> ${e.type||"未知"}</p>
  `,e.arrayBuffer().then(t=>{const n=$(t);V.textContent=`原始 MD5: ${n}`,u.disabled=!1,a.textContent="",a.className="status"}).catch(t=>{console.error("计算哈希时出错:",t),a.textContent="计算哈希时出错: "+t.message,a.className="status error"})}function O(e){if(e.length===0){H();return}P=e,r=[...e],R.textContent=e.length,re(),d.disabled=!1,a.textContent="",a.className="status"}z.addEventListener("change",e=>{e.target.files.length>0&&ce(e.target.files[0])});U.addEventListener("change",e=>{e.target.files.length>0&&O(Array.from(e.target.files))});function S(e){I.querySelectorAll(".file-item").forEach(s=>s.classList.remove("selected"));const n=I.querySelector(`[data-index="${e}"]`);n&&n.classList.add("selected"),c=r[e],q.innerHTML=`
    <p><strong>名称:</strong> ${c.name}</p>
    <p><strong>大小:</strong> ${(c.size/1024).toFixed(2)} KB</p>
    <p><strong>类型:</strong> ${c.type||"未知"}</p>
  `,c.arrayBuffer().then(s=>{const o=$(s);V.textContent=`原始 MD5: ${o}`}).catch(s=>{console.error("计算哈希时出错:",s),a.textContent="计算哈希时出错: "+s.message,a.className="status error"});const i=y.find(s=>s.originalFile===c);i?K(i.modifiedFile,i.modifiedArray,i.changedPosition):b.style.display="none"}function we(e){if(e.type){if(e.type.startsWith("image/"))return"image";if(e.type.startsWith("text/")||e.type.includes("json")||e.type.includes("javascript")||e.type.includes("css")||e.type.includes("html")||e.type.includes("xml"))return"text"}const t=e.name.split(".").pop().toLowerCase(),n=["txt","md","js","ts","html","css","json","xml","csv","log"],i=["jpg","jpeg","png","gif","bmp","webp","svg"];return n.includes(t)?"text":i.includes(t)?"image":"binary"}async function K(e,t,n){b.style.display="block",h.innerHTML="";const i=we(e);if(i==="image"){const s=URL.createObjectURL(e),o=document.createElement("img");o.src=s,o.className="preview-image",h.appendChild(o),o.onload=()=>URL.revokeObjectURL(s)}else if(i==="text")try{const s=await e.text(),o=document.createElement("pre");o.className="preview-text",o.textContent=s,h.appendChild(o)}catch(s){h.textContent="加载文本预览时出错: "+s.message}else{const s=document.createElement("div");s.className="preview-binary";const o=Math.min(t.length,256);for(let l=0;l<o;l++){const g=document.createElement("span");g.textContent=t[l].toString(16).padStart(2,"0").toUpperCase(),l===n&&(g.className="modified",g.title="已修改的字节"),s.appendChild(g)}if(t.length>256){const l=document.createElement("div");l.textContent=`... 还有 ${t.length-256} 个字节`,l.style.marginTop="10px",l.style.textAlign="center",h.appendChild(s),h.appendChild(l)}else h.appendChild(s)}}async function de(e){try{const t=await e.arrayBuffer(),n=new Uint8Array(t);let i,s=-1;if(T.checked){const v=ne.value,M=be(v),W=new Uint8Array(M);i=new Uint8Array(n.length+W.length),i.set(n),i.set(W,n.length),s=n.length}else if(N.checked){const v=parseInt(se.value),M=ve(ie.value);if(v>=n.length)throw new Error(`位置 ${v} 超出范围 (文件大小: ${n.length} 字节)`);i=new Uint8Array(t),i[v]=M,s=v}const o=$(t),l=$(i.buffer),g=new Blob([i],{type:e.type}),pe=new File([g],e.name,{type:e.type,lastModified:new Date().getTime()});return{originalFile:e,modifiedFile:pe,modifiedArray:i,originalHash:o,newHash:l,changedPosition:s,success:!0}}catch(t){return console.error("修改文件时出错:",t),{originalFile:e,success:!1,error:t.message}}}u.addEventListener("click",async()=>{if(c)try{const e=await de(c);if(e.success)k=e.modifiedFile,oe=e,X.textContent=`修改后 MD5: ${e.newHash}`,m.disabled=!1,c=e.modifiedFile,a.textContent=T.checked?`已在文件末尾追加 "${ne.value}"。MD5 从 ${e.originalHash} 变为 ${e.newHash}`:`已将位置 ${se.value} 的字节修改为 0x${ie.value}。MD5 从 ${e.originalHash} 变为 ${e.newHash}`,a.className="status success",K(e.modifiedFile,e.modifiedArray,e.changedPosition);else throw new Error(e.error)}catch(e){console.error("修改文件时出错:",e),a.textContent="修改文件时出错: "+e.message,a.className="status error"}});d.addEventListener("click",async()=>{if(r.length===0)return;y=[],D.innerHTML="",Y.style.display="block",G.style.display="block",d.disabled=!0,p.disabled=!0;let e=0,t=0;for(let n=0;n<r.length;n++){const i=r[n],s=await de(i);if(s.success){y.push(s),e++,r[n]=s.modifiedFile;const l=document.createElement("div");l.className="result-item",l.innerHTML=`
        <span>${i.name}</span>
        <span>✅ MD5: ${s.originalHash} → ${s.newHash}</span>
      `,l.addEventListener("click",()=>{S(n),K(s.modifiedFile,s.modifiedArray,s.changedPosition)}),D.appendChild(l)}else{t++;const l=document.createElement("div");l.className="result-item",l.innerHTML=`
        <span>${i.name}</span>
        <span>❌ 错误: ${s.error}</span>
      `,D.appendChild(l)}const o=Math.round((n+1)/r.length*100);ee.style.width=`${o}%`,te.textContent=`${o}% (${n+1}/${r.length})`}a.textContent=`成功修改 ${e} 个文件。${t} 个文件失败。`,a.className=t>0?"status error":"status success",p.disabled=y.length===0,d.disabled=!1,y.length>0&&S(0)});m.addEventListener("click",()=>{k&&Q(k,k.name)});p.addEventListener("click",async()=>{if(y.length===0)return;const e=new ue;y.forEach(n=>{e.file(n.modifiedFile.name,n.modifiedFile)});const t=await e.generateAsync({type:"blob"});Q(t,"modified_files.zip")});f.addEventListener("change",()=>{x.forEach(e=>{e.disabled=f.checked,f.checked&&(e.checked=!1)}),A()});x.forEach(e=>{e.addEventListener("change",()=>{e.checked&&(f.checked=!1),Array.from(x).some(n=>n.checked)||(f.checked=!0,x.forEach(n=>{n.disabled=!0})),A()})});me.addEventListener("click",()=>{const e=Z.value.trim().toLowerCase();if(e&&!w.includes(e)){w.push(e);const t=document.createElement("span");t.className="file-type-badge",t.style.margin="5px",t.style.cursor="pointer",t.textContent=e,t.title="点击移除",t.addEventListener("click",()=>{_.removeChild(t),w=w.filter(n=>n!==e),A()}),_.appendChild(t),Z.value="",f.checked&&(f.checked=!1,x.forEach(n=>{n.disabled=!1})),A()}});T.addEventListener("change",()=>{T.checked&&(document.getElementById("appendOptions").style.display="block",document.getElementById("byteOptions").style.display="none")});N.addEventListener("change",()=>{N.checked&&(document.getElementById("appendOptions").style.display="none",document.getElementById("byteOptions").style.display="block")});function H(){q.textContent="未选择文件",V.textContent="",X.textContent="",u.disabled=!0,d.disabled=!0,m.disabled=!0,p.disabled=!0,a.textContent="",a.className="status",Y.style.display="none",ee.style.width="0%",te.textContent="0%",b.style.display="none",c=null,k=null,oe=null,y=[],L.checked?z.value="":(U.value="",I.innerHTML="",R.textContent="0")}
